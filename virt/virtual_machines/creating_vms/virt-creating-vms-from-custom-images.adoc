:_content-type: ASSEMBLY
[id="virt-creating-vms-from-custom-images"]
= Creating virtual machines from custom images
include::_attributes/common-attributes.adoc[]
:context: virt-creating-vms-from-custom-images
:toclevels: 3

toc::[]

You can create virtual machines (VMs) from custom operating system images by using one of the following methods:

* Importing the image as a container disk from a registry.
* Importing the image from a web page.
* Uploading the image from a local machine.
* Cloning a persistent volume claim (PVC) that contains the image.

The Containerized Data Importer (CDI) imports the image into a PVC by using a data volume. You add the PVC to the VM by using the {product-title} web console or command line.

[NOTE]
====
After you create the VM, you must install the QEMU guest agent on the VM.

The QEMU guest agent is included with Red Hat images.
====

[id="importing-container-disks-to-create-vms"]
== Importing container disks to create VMs

You can create virtual machines (VMs) by importing container disks from a registry.

You build a custom image into a container disk and upload it to your container registry. If your container registry does not have TLS you must add it as an insecure registry before you can import container disks into persistent storage.

Then, you can import the container disk into persistent storage by using a data volume.

// To do: Add link after moving auto updates to storage config
You can enable auto updates for container disks.

[IMPORTANT]
====
If you use large container disks, I/O traffic might increase and might cause worker nodes to be unavailable. You can perform the following tasks to resolve this issue:

* xref:../../../applications/pruning-objects.adoc#pruning-deployments_pruning-objects[Pruning `DeploymentConfig` objects]
* xref:../../../nodes/nodes/nodes-nodes-garbage-collection.adoc#nodes-nodes-garbage-collection-configuring_nodes-nodes-configuring[Configuring garbage collection]
====

include::modules/virt-preparing-container-disk-for-vms.adoc[leveloffset=+2]

include::modules/virt-disabling-tls-for-registry.adoc[leveloffset=+2]

:context: creating-vms-from-container-disks
include::modules/virt-creating-vm-custom-image-web.adoc[leveloffset=+2]

include::modules/virt-importing-vm-datavolume.adoc[leveloffset=+2]
:!creating-vms-from-container-disks:

[id="importing-web-images-to-create-vms"]
== Importing images on web pages to create VMs

You can create virtual machines (VMs) by importing operating system images from web pages.

:context: creating-vms-from-web-images
include::modules/virt-creating-vm-custom-image-web.adoc[leveloffset=+2]

include::modules/virt-importing-vm-datavolume.adoc[leveloffset=+2]
:!creating-vms-from-web-images:

[id="uploading-images-to-create-vms"]
== Uploading images to create VMs

You can create virtual machines (VMs) by uploading operating system images from your local machine.

include::modules/virt-creating-vm-uploaded-image-web.adoc[leveloffset=+2]

include::modules/virt-using-disk-image-install-windows.adoc[leveloffset=+2]

include::modules/virt-generalizing-windows-sysprep.adoc[leveloffset=+3]

include::modules/virt-specializing-windows-sysprep.adoc[leveloffset=+3]

[role="_additional-resources"]
[id="additional-resources-creating-windows-vms"]
==== Additional resources for creating Windows VMs
* xref:../../../virt/virtual_machines/virt-installing-qemu-guest-agent.adoc#virt-installing-qemu-guest-agent[Installing the QEMU guest agent and VirtIO drivers]
* link:https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/sysprep\--generalize\--a-windows-installation[Microsoft, Sysprep (Generalize) a Windows installation]
* link:https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/generalize[Microsoft, generalize]
* link:https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/specialize[Microsoft, specialize]

// uploading image with cli
include::modules/virt-uploading-image-virtctl.adoc[leveloffset=+2]

To do: Editing VM spec to include DV from uploaded image

[id="cloning-pvcs-to-create-vms"]
== Cloning PVCs to create VMs

You can create virtual machines (VMs) by cloning persistent volume claims (PVCs) with custom images.

You clone a PVC by creating a data volume that references a source PVC.

:context: creating-vms-by-cloning-pvcs
include::modules/virt-creating-vm-custom-image-web.adoc[leveloffset=+2]
:!creating-vms-by-cloning-pvcs:

[id="creating-vm-by-cloning-pvcs-cli"]
=== Creating a VM from a cloned PVC by using the command line

You can create a virtual machine (VM) by cloning the persistent volume claim (PVC) of an existing VM by using the command line.

You can clone the PVC by using one of the following options:

* Cloniing the PVC to a new data volume.
+
This method creates a data volume whose lifecycle is independent of the original VM. Deleting the original VM does not affect the new data volume or its associated PVC.

* Cloning the PVC by creating a `VirtualMachine` manifest with a `dataVolumeTemplates` stanza.
+
This method creates a data volume whose lifecycle is dependent on the original VM. Deleting the original VM deletes the cloned data volume and its associated PVC.

include::modules/virt-cloning-pvc-to-dv-cli.adoc[leveloffset=+3]

To do: how to configure VM to use new DV

include::modules/virt-creating-vm-cloned-pvc-data-volume-template.adoc[leveloffset=+3]

